<html>
<head>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script src="js/filesaver/FileSaver.min.js"></script>
<script src="js/jszip/jszip.min.js"></script>
<script type="text/javascript">
    var iconFolder
    var bannerFolder

    var fileArray = new Array()
    var folderArray = new Array()
    var index = 0

    var capsule = {}

    const done = () => {
        var appname = document.getElementById("appname-default").value
        var appNameEn = document.getElementById("appname-en").value
        var appNameCn = document.getElementById("appname-cn").value

        if (appname == "") {
            alert("请输入应用名称")
            return
        }

        capsule.name = appname
        capsule.name_en = appNameEn
        capsule.name_zh_CN = appNameCn

        let appId = document.getElementById("appid").value
        if (appId == "") {
            alert("请输入App Id")
            return
        }
        capsule.appId = appId

        let did = document.getElementById("did").value
        let publickey = document.getElementById("publickey").value
        if (did == "" || publickey == "") {
            alert("请输入开发者信息")
            return
        }

        capsule.did = did
        capsule.publicKey = publickey

        getFile("icon-default", "icon", "icon")

        getFile("icon-1x", "icon", "icon_xhdpi")
        getFile("icon-2x", "icon", "icon_xxhdpi")
        getFile("icon-2x", "icon", "icon_xxxhdpi")


        getFile("banner-default", "banner", "banner")

        getFile("banner-en-1x", "banner", "banner_en_xhdpi")
        getFile("banner-en-2x", "banner", "banner_en_xxhdpi")
        getFile("banner-en-3x", "banner", "banner_en_xxxhdpi")

        getFile("banner-cn-1x", "banner", "banner_cn_xhdpi")
        getFile("banner-cn-2x", "banner", "banner_cn_xxhdpi")
        getFile("banner-cn-3x", "banner", "banner_cn_xxxhdpi")

        capsule.shortDesc = document.getElementById("shortDesc-default").value
        capsule.shortDesc_en = document.getElementById("shortDesc-en").value
        capsule.shortDesc_zh_CN = document.getElementById("shortDesc-cn").value

        capsule.longDesc = document.getElementById("longDesc-default").value
        capsule.longDesc_en = document.getElementById("longDesc-en").value
        capsule.longDesc_zh_CN = document.getElementById("longDesc-cn").value

        var radios = document.getElementsByName('category');
        for (var i = 0; i < radios.length; i++) {
            if (radios[i].checked) {
                capsule.category = radios[i].value
                break;
            }
        }
        if (capsule.category == undefined) {
            alert("请选择分类")
            return
        }

        radios = document.getElementsByName('platform');
        for (var i = 0; i < radios.length; i++) {
            if (radios[i].checked) {
                capsule.platform = radios[i].value
                break;
            }
        }
        if (capsule.platform == undefined) {
            alert("请选择平台")
            return
        }

        capsule.version = document.getElementById("version").value

        var releaseNote = document.getElementById("releaseNote").value
        if (releaseNote != "") {
            capsule.releaseNote = releaseNote
        }

        var url = document.getElementById("url").value
        if (url == "") {
            alert("请输入链接")
            return
        }
        capsule.url = url

        if (capsule.platform != "Web") {
            capsule.size = parseInt(document.getElementById("size").value)
            capsule.hash = document.getElementById("hash").value
        }

        let jsonstr = JSON.stringify(capsule, null, 4)
        console.log(jsonstr)
        var capsuleName = document.getElementById("filename").value
        if (capsuleName == "") {
            alert("请输入capsule文件名")
            return
        }

        var zip = new JSZip()
        zip.file("app.json", jsonstr)

        iconFolder = zip.folder("icon")
        bannerFolder = zip.folder("banner")

        try {
            readFiles().then( () => {
                    zip.generateAsync({type:"blob"})
                        .then(function(content) {
                            // see FileSaver.js
                            saveAs(content, capsuleName + ".capsule");
                        });

                })

        } catch (e) {
            console.log(e)
        }

    }

    const getFile = (id, folder, key) => {
        let file = document.getElementById(id).files[0]
        if (file === undefined) return

        capsule[key] = folder + "/" + file.name
        folderArray[index] = folder
        fileArray[index] = file
        index++
    }

    async function readFiles() {
        for (var i = 0; i < index; i++) {
            let data = await new Promise(resolve => {
                const reader = new FileReader()
                reader.onload = evt => resolve(evt.target.result)
                reader.readAsBinaryString(fileArray[i])
            })
            if (folderArray[i] == 'icon') {
                iconFolder.file(fileArray[i].name, data, {binary: true})
            } else {
                bannerFolder.file(fileArray[i].name, data, {binary: true})
            }
        }
    }

</script>
<style>
    textarea {
        font-size: 20px;
        vertical-align: middle;
    }

    lable {
        text-align: center;
        vertical-align: middle;
    }

</style>
</head>
<body>

<p style="font-size: 22px">应用名称</p>
<div >
    <lable >default</lable>
    <textarea id="appname-default" style="width:450px; height: 30px; padding-left: 10px;" row="1"></textarea>
</div>

<div style="padding-top: 10px">
    <lable >英文</lable>
    <textarea id="appname-en" style="width:450px; height: 30px; padding-left: 10px;" row="1"></textarea>
</div>

<div style="padding-top: 10px">
    <lable >中文</lable>
    <textarea id="appname-cn" style="width:450px; height: 30px; padding-left: 10px;" row="1"></textarea>
</div>

<div style="padding-top: 10px">
    <lable >appId</lable>
    <textarea id="appid" style="width:450px; height: 60px; padding-left: 10px;" row="1"></textarea>
</div>

<p style="font-size: 22px">开发者信息</p>
<div>
    <lable >DID</lable>
    <textarea id="did" style="width:450px; height: 30px; padding-left: 10px;" row="1"></textarea>
</div>

<div style="padding-top: 10px">
    <lable >公钥</lable>
    <textarea id="publickey" style="width:450px; height: 60px; padding-left: 10px;" row="1"></textarea>
</div>

<p style="font-size: 22px">图标包内路径</p>

<div >
    <lable >default</lable>
    <input type="file" id="icon-default"/>
</div>

<div  style="padding-top: 10px">
    <lable >xhdpi</lable>
    <input type="file" id="icon-1x"/>
</div>

<div style="padding-top: 10px">
    <lable >xxhdpi</lable>
    <input type="file" id="icon-2x"/>
</div>
<div style="padding-top: 10px">
    <lable >xxxhdpi</lable>
    <input type="file" id="icon-3x"/>
</div>


<p style="font-size: 22px">banner包内路径</p>
<div >
    <lable >default</lable>
    <input type="file" id="banner-default"/>
</div>

<p>英文</p>
<div>
    <lable >xhdpi</lable>
    <input type="file" id="banner-en-1x"/>
</div>

<div style="padding-top: 10px">
    <lable >xxhdpi</lable>
    <input type="file" id="banner-en-2x"/>
</div>
<div style="padding-top: 10px">
    <lable >xxxhdpi</lable>
    <input type="file" id="banner-en-3x"/>
</div>

<p>中文</p>
<div>
    <lable >xhdpi</lable>
    <input type="file" id="banner-cn-1x"/>
</div>

<div style="padding-top: 10px">
    <lable >xxhdpi</lable>
    <input type="file" id="banner-cn-2x"/>
</div>
<div style="padding-top: 10px">
    <lable >xxxhdpi</lable>
    <input type="file" id="banner-cn-3x"/>
</div>

<div style="padding-top: 20px">
    <lable >notificationUrl</lable>
    <textarea id="notificationUrl" style="width:450px; height: 30px; margin-left: 10px;" row="1"></textarea>
</div>


<p style="font-size: 22px">shortDesc</p>
<div >
    <lable >default</lable>
    <textarea id="shortDesc-default" style="width:450px; height: 100px; padding-left: 10px;" row="1"></textarea>
</div>

<div style="padding-top: 10px">
    <lable >英文</lable>
    <textarea id="shortDesc-en" style="width:450px; height: 100px; margin-left: 10px;" row="1"></textarea>
</div>

<div style="padding-top: 10px">
    <lable >中文</lable>
    <textarea id="shortDesc-cn" style="width:450px; height: 100px; margin-left: 10px;" row="1"></textarea>
</div>

<p style="font-size: 22px">longDesc</p>
<div >
    <lable >default</lable>
    <textarea id="longDesc-default" style="width:450px; height: 100px; padding-left: 10px;" row="1"></textarea>
</div>
<div style="padding-top: 10px">
    <lable >英文</lable>
    <textarea id="longDesc-en" style="width:450px; height: 150px; margin-left: 10px;" row="1"></textarea>
</div>

<div style="padding-top: 10px">
    <lable >中文</lable>
    <textarea id="longDesc-cn" style="width:450px; height: 150px; margin-left: 10px;" row="1"></textarea>
</div>

<form action="" method="get" style="margin-top: 20px">
<p style="font-size: 22px">分类</p>
<label><input name="category" type="radio" value="game" />game </label>
<label><input name="category" type="radio" value="health" />health </label>
<label><input name="category" type="radio" value="map" />map </label>
<label><input name="category" type="radio" value="food" />food </label>
<label><input name="category" type="radio" value="business" />business </label>
<label><input name="category" type="radio" value="beauty" />beauty </label>
<label><input name="category" type="radio" value="education" />education </label>
<label><input name="category" type="radio" value="books" />books </label>
<label><input name="category" type="radio" value="entertainment" />entertainment </label>
<label><input name="category" type="radio" value="lifestyle" />lifestyle </label>
<label><input name="category" type="radio" value="events" />events </label>
<label><input name="category" type="radio" value="home" />home </label>
<label><input name="category" type="radio" value="tools" />tools </label>
</form>

<form action="" method="get" style="margin-top: 20px">
<p style="font-size: 22px">Platform</p>
<label><input name="platform" type="radio" value="Web" />Web </label>
<label><input name="platform" type="radio" value="H5" />H5 </label>
</form>


<div style="padding-top: 20px">
    <lable >版本号</lable>
    <textarea id="version" style="width:100px; height: 30px; margin-left: 10px;" row="1"></textarea>
</div>

<div style="padding-top: 20px">
    <lable >ReleaseNote</lable>
    <textarea id="releaseNote" style="width:450px; height: 150px; margin-left: 10px;" row="1"></textarea>
</div>


<div style="padding-top: 20px">
    <lable >Url</lable>
    <textarea id="url" style="width:450px; height: 30px; margin-left: 10px;" row="1"></textarea>
</div>

<div style="padding-top: 20px">
    <lable >H5运行包大小</lable>
    <textarea id="size" style="width:100px; height: 30px; margin-left: 10px;" row="1"></textarea>
    <lable >KB</lable>
</div>

<div style="padding-top: 20px">
    <lable >H5运行包hash</lable>
    <textarea id="hash" style="width:450px; height: 30px; margin-left: 10px;" row="1"></textarea>
</div>

<div style="padding-top: 20px">
    <lable >capsule文件名</lable>
    <textarea id="filename" style="width:200px; height: 30px; margin-left: 10px;" row="1"></textarea>
</div>

<br/>
<div>
<button type="button" onclick="done()" style="width:100px; height:30px;">完成</button>
</div>

<br/>
<br/>

</body>
</html>
